---
title: "C01-C03 Observations, Background, and Covariates - Right Whale (Eubalaena glacialis)"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

```{r source_setup, message=FALSE, warning=FALSE}
source("setup.R")
SPECIES <- "Eubalaena glacialis"
```

# C01: Observations

## Fetch and Read Data

```{r fetch_data}
fetch_obis(SPECIES)
```

```{r read_obs}
obs <- read_observations(scientificname = SPECIES)
dim(obs)
```

## Explore the Data

```{r basisOfRecord}
obs |> count(basisOfRecord)
```

```{r year_distribution}
obs |> count(year) |> print(n = 30)
```

```{r month_distribution}
obs |> count(month)
```

## Spatial Distribution

```{r load_coast}
coast <- read_coastline()
```

```{r plot_observations}
ggplot() +
  geom_sf(data = obs, alpha = 0.3, size = 0.5, color = "blue") +
  geom_sf(data = coast, fill = "tan", color = "darkgreen") +
  labs(title = paste("Observations -", SPECIES),
       x = "Longitude", y = "Latitude") +
  theme_minimal()
```

# C02: Background Points

## Load Mask

```{r load_mask}
db <- brickman_database() |>
  filter(scenario == "STATIC", var == "mask")
mask <- read_brickman(db)
```

## Count Observations per Month

```{r all_observations_count}
LON0 <- -67
LAT0 <- 46
all_counts <- count(st_drop_geometry(obs), month)
all_counts
```

## Plot All Observations by Month

```{r all_observations}
ggplot() +
  geom_sf(data = obs, alpha = 0.2, shape = "circle small", size = 1) +
  geom_sf(data = coast, col = "orange") +
  geom_text(data = all_counts,
            mapping = aes(x = LON0, 
                          y = LAT0, 
                          label = sprintf("n: %i", .data$n)),
                          size = 3) + 
  labs(x = "Longitude", y = "Latitude", title = paste("All observations -", SPECIES)) +
  facet_wrap(~month)
```

## Thinning Observations

```{r thin_observations}
thinned_obs <- sapply(month.abb,
               function(mon){ 
                 thin_by_cell(obs |> filter(month == mon), mask)
               }, simplify = FALSE) |>
  dplyr::bind_rows() 

thinned_counts <- count(st_drop_geometry(thinned_obs), month)
thinned_counts
```

```{r plot_thinned}
ggplot() +
  geom_sf(data = thinned_obs, 
          alpha = 0.2, 
          shape = "circle small", 
          size = 1) +
  geom_sf(data = coast, col = "orange") +
  geom_text(data = thinned_counts,
            mapping = aes(x = LON0, 
                          y = LAT0, 
                          label = sprintf("n: %i", .data$n)),
                          size = 3) + 
  labs(x = "Longitude", y = "Latitude", title = paste("Thinned observations -", SPECIES)) +
  facet_wrap(~month)
```

## Create Bias Map

```{r bias_map}
bias_map <- rasterize_point_density(obs, mask)

ggplot() +
  geom_stars(data = bias_map, aes(fill = count)) +
  scale_fill_viridis_b(na.value = "transparent") +
  geom_sf(data = coast, col = "orange") + 
  labs(x = "Longitude", y = "Latitude", title = paste("Bias map -", SPECIES))
```

## Sample Background Points

```{r n_background_per_month}
nback_avg <- mean(all_counts$n) |> round()
nback_avg
```

```{r sample_background}
obsbkg <- sapply(month.abb,
    function(mon){ 
      sample_background(thinned_obs |> filter(month == mon),
                       bias_map,
                       method = "bias",
                       return_pres = TRUE,
                       n = nback_avg) |>
        mutate(month = mon, .before = 1)
    }, simplify = FALSE) |>
  bind_rows() |>
  mutate(month = factor(month, levels = month.abb))

obsbkg
```

## Check Counts

```{r nback_avg_check}
count(st_drop_geometry(obsbkg), month, class)
```

## Plot Presence vs Background

```{r plot_presence_background}
ggplot() +
  geom_sf(data = obsbkg, 
          mapping = aes(col = class),
          alpha = 0.4, shape = "circle small", size = 1) +
  geom_sf(data = coast, col = "orange")  + 
  labs(x = "Longitude", y = "Latitude", title = paste("Presence/Background -", SPECIES)) +   
  theme_bw() +
  scale_fill_okabe_ito() +
  facet_wrap(~month)
```

## Save Model Input

```{r save_model_input}
write_model_input(obsbkg, scientificname = SPECIES)
```

# C03: Covariates

## Read Brickman Covariates

```{r read_brickman}
db <- brickman_database() |>
  dplyr::filter(scenario == "PRESENT", interval == "mon")
present <- read_brickman(db)
present
```

## Pairs Plot

```{r pairs}
pairs(present)
```

## Identify Collinear Variables

```{r filter_collinear}
keep <- filter_collinear(present, method = "cor_caret", cutoff = 0.65)
keep
```

```{r drop_me}
drop_me <- attr(keep, "to_remove")
drop_me
```

## Add Depth and Month

```{r add_depth_and_month}
keep <- c("depth", "month", keep)
keep
```

## Save Configuration

```{r save_config}
cfg <- list(
  scientificname = SPECIES,
  version = "v1",
  keep = keep
)
write_configuration(cfg)
```

## Verify Configuration

```{r read_config}
cfg <- read_configuration(scientificname = SPECIES, version = "v1")
cfg
```

# Summary

Prepared Right Whale (Eubalaena glacialis) data for modeling:

- Original observations: `r nrow(obs)`
- Thinned observations: `r nrow(thinned_obs)`
- Background points per month: `r nback_avg`
- Total model input records: `r nrow(obsbkg)`
- Selected covariates: `r paste(keep, collapse = ", ")`
